const express = require('express');
const cors = require('cors');
const { Pool } = require('pg');
const path = require('path'); // Required to serve files
const fetch = (...args) => import('node-fetch').then(({default: fetch}) => fetch(...args));
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json({ limit: '50mb' }));

// ----------------------------------------------------
// 1. SERVE STATIC FILES (The HTML/JS you uploaded)
// ----------------------------------------------------
app.use(express.static(path.join(__dirname, 'public')));

// ----------------------------------------------------
// 2. DATABASE CONNECTION
// ----------------------------------------------------
const pool = new Pool({
    host: process.env.DB_HOST || 'localhost',
    port: process.env.DB_PORT || 5433, // Check your port (5432 or 5433)
    user: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD || '1234',
    database: process.env.DB_NAME || 'rbims',
});

// ----------------------------------------------------
// 3. API ROUTES
// ----------------------------------------------------

// GET Equipment List
app.get('/api/equipment', async (req, res) => {
    try {
        const result = await pool.query('SELECT equipment_id, equipment_no, equipment_desc FROM equipment WHERE is_active = true ORDER BY equipment_no');
        res.json({ success: true, data: result.rows });
    } catch (err) { res.status(500).json({ error: { message: err.message } }); }
});

// GET Equipment List with Counts (For Equipment Manager Page)
app.get('/api/equipment-list', async (req, res) => {
    try {
        const result = await pool.query(`
            SELECT e.*, (SELECT COUNT(*) FROM equipment_part ep WHERE ep.equipment_id = e.equipment_id) as parts_count
            FROM equipment e ORDER BY e.equipment_no
        `);
        res.json({ success: true, data: result.rows });
    } catch (err) { res.status(500).json({ error: { message: err.message } }); }
});

// GET Parts for specific Equipment
app.get('/api/equipment-parts/:id', async (req, res) => {
    try {
        const result = await pool.query('SELECT * FROM equipment_part WHERE equipment_id = $1', [req.params.id]);
        res.json({ success: true, data: result.rows });
    } catch (err) { res.status(500).json({ error: { message: err.message } }); }
});

// POST Add New Equipment
app.post('/api/add-equipment', async (req, res) => {
    const { equipment_no, pmt_no, equipment_desc, parts } = req.body;
    const client = await pool.connect();
    try {
        await client.query('BEGIN');
        const eqRes = await client.query(
            'INSERT INTO equipment (equipment_no, pmt_no, equipment_desc, is_active) VALUES ($1, $2, $3, true) RETURNING equipment_id',
            [equipment_no, pmt_no, equipment_desc]
        );
        const eqId = eqRes.rows[0].equipment_id;

        if (parts && parts.length > 0) {
            for (const part of parts) {
                if (part.trim()) {
                    await client.query('INSERT INTO equipment_part (equipment_id, part_name, is_active) VALUES ($1, $2, true)', [eqId, part.trim()]);
                }
            }
        }
        await client.query('COMMIT');
        res.json({ success: true, message: 'Saved' });
    } catch (err) {
        await client.query('ROLLBACK');
        res.status(500).json({ error: { message: err.message } });
    } finally { client.release(); }
});

// DELETE Equipment
app.delete('/api/delete-equipment/:id', async (req, res) => {
    const client = await pool.connect();
    try {
        await client.query('BEGIN');
        await client.query('DELETE FROM equipment_part WHERE equipment_id = $1', [req.params.id]);
        await client.query('DELETE FROM equipment WHERE equipment_id = $1', [req.params.id]);
        await client.query('COMMIT');
        res.json({ success: true });
    } catch (err) {
        await client.query('ROLLBACK');
        res.status(500).json({ error: { message: err.message } });
    } finally { client.release(); }
});

// AI EXTRACTION (Gemini)
app.post('/api/extract-data', async (req, res) => {
    try {
        const { imageBase64, partsList } = req.body;
        const partNames = (partsList && partsList.length > 0) ? partsList.join(', ') : "all parts";
        
        // ... (Paste your previous Gemini Prompt logic here if needed) ...
        // For brevity, assuming you have the prompt logic from previous conversation:
        const prompt = `Extract design/operating pressure and temp from table. Map to parts: ${partNames}. Return JSON.`; 
        
        const apiKey = process.env.GEMINI_API_KEY;
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: "image/png", data: imageBase64 } } ] }]
        };

        const apiResponse = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await apiResponse.json();
        let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
        text = text.replace(/```json/g, '').replace(/```/g, '').trim();
        res.json({ success: true, data: JSON.parse(text) });

    } catch (error) {
        console.error("AI Error:", error);
        res.status(500).json({ error: { message: "AI extraction failed: " + error.message } });
    }
});

// START SERVER
app.listen(PORT, () => {
    console.log(`-------------------------------------------`);
    console.log(`ðŸš€ Server running at http://localhost:${PORT}`);
    console.log(`ðŸ“„ Pages accessible at:`);
    console.log(`   - Inspection: http://localhost:${PORT}/test.html`);
    console.log(`   - Equipment:  http://localhost:${PORT}/equipment.html`);
    console.log(`-------------------------------------------`);
});











